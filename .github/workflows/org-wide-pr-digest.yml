name: Org-Wide PR Digest (gh search optimized)

on:
  schedule:
    - cron: "0 16 * * 1-5"   # Every weekday at 9 AM MST
  workflow_dispatch:

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Fetch ALL open PRs across org (1 call via gh search)
        id: prs
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: |
          prs=$(gh search prs \
            --owner ppnishanth-exp \
            --state open \
            --json number,title,url,author,createdAt)

          {
            echo "all_prs<<EOF"
            echo "$prs"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Fetch ALL Slack users (1 call)
        id: slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          slack_users=$(curl -s -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            https://slack.com/api/users.list)

          {
            echo "slack_users<<EOF"
            echo "$slack_users"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Process + Send Slack DMs (local processing only)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          prs='${{ steps.prs.outputs.all_prs }}'
          slack='${{ steps.slack.outputs.slack_users }}'

          echo "ðŸ” Validating Slack API response..."

          ok=$(echo "$slack" | jq -r '.ok // empty')
          if [ "$ok" != "true" ]; then
            echo "âŒ Slack API returned an error:"
            echo "$slack"
            exit 1
          fi

          members_type=$(echo "$slack" | jq -r '.members | type')
          if [ "$members_type" != "array" ]; then
            echo "âŒ Slack API did not return a valid members array"
            echo "$slack"
            exit 1
          fi

          echo "ðŸ“¥ Building Slack user cache..."
          echo "$slack" | jq -r '.members[] | "\(.name) \(.id)"' > slack_cache.txt
          echo "$slack" | jq -r '.members[] | "\(.profile.display_name) \(.id)"' >> slack_cache.txt
          echo "$slack" | jq -r '.members[] | "\(.profile.real_name) \(.id)"' >> slack_cache.txt

          get_slack_id() {
            local username="$1"
            grep -i "^$username " slack_cache.txt | awk '{print $2}' | head -n 1
          }

          echo "ðŸ“¦ Normalizing PRs..."
          echo "$prs" | jq '
            map(select(.author != null)) |
            map({
              number,
              title,
              url,
              createdAt,
              author: .author.login
            })
          ' > normalized.json

          echo "ðŸ“¦ Grouping PRs by author (guaranteed flat)..."
          jq '
            group_by(.author)
            | map({key: .[0].author, value: .})
            | from_entries
          ' normalized.json > grouped.json

          now=$(date +%s)

          for author in $(jq -r 'keys[]' grouped.json); do
            echo "ðŸ” Resolving Slack ID for GitHub user: $author"

            slack_id=$(get_slack_id "$author")
            if [ -z "$slack_id" ]; then
              echo "âš ï¸ No Slack ID found for $author â€” skipping"
              continue
            fi

            jq -c --arg a "$author" '
              .[$a] |
              map(. + {createdEpoch: (.createdAt | fromdate)}) |
              sort_by(.createdEpoch)
            ' grouped.json \
            | while read pr; do
                number=$(echo "$pr" | jq -r '.number')
                title=$(echo "$pr" | jq -r '.title')
                url=$(echo "$pr" | jq -r '.url')
                created=$(echo "$pr" | jq -r '.createdAt')

                created_epoch=$(date -d "$created" +%s)
                age_days=$(( (now - created_epoch) / 86400 ))

                echo "- *#$number* $title (ðŸ•’ ${age_days}d)\n  $url"
              done > message.txt

            text="*Your Open PRs Across the Organization*\n$(cat message.txt)"

            echo "ðŸ“¨ Sending DM to $author ($slack_id)"

            curl -s -X POST \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "{\"channel\":\"$slack_id\",\"text\":\"$text\"}" \
              https://slack.com/api/chat.postMessage
          done