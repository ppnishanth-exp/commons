name: Org-Wide PR Digest (Channel Post)

on:
  schedule:
    - cron: "*/5 * * * *"   # Every 5 minutes (adjust as needed)
  workflow_dispatch:

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Fetch ALL open PRs across org
        id: prs
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: |
          prs=$(gh search prs \
            --owner ppnishanth-exp \
            --state open \
            --json number,title,url,author,createdAt)

          {
            echo "all_prs<<EOF"
            echo "$prs"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build Slack message grouped by author
        id: build
        run: |
          prs='${{ steps.prs.outputs.all_prs }}'

          jq -r '
            if length == 0 then
              "No open PRs across the organization."
            else
              group_by(.author.login)
              | sort_by(.[0].author.login)
              | map(
                  "*Author: @\([0].author.login)*\n"
                  +
                  (
                    map(
                      "- *#\(.number)* \(.title)\n  \(.url)"
                    )
                    | join("\n")
                  )
                )
              | join("\n\n")
            end
          ' <<< "$prs" > message.txt

          {
            echo "text<<EOF"
            echo "*Open PRs Across the Organization (Grouped by Author)*"
            echo
            cat message.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post PR digest to Slack channel
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: "C0ABG89R3J6"
        run: |
          text='${{ steps.build.outputs.text }}'

          echo "ðŸ“¨ Sending PR digest to Slack channel $SLACK_CHANNEL_ID"

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"channel\":\"$SLACK_CHANNEL_ID\",\"text\":\"$text\"}" \
            https://slack.com/api/chat.postMessage